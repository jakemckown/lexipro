!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Preprocessor=e()}(this,(function(){"use strict";var t=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){function e(t){"function"!=typeof t&&(t=e.defunct);var i=[],n=[],r=0;function s(){for(var t=[],e=0,i=this.state,r=this.index,s=this.input,o=0,h=n.length;o<h;o++){var c=n[o],u=c.start,a=u.length;if(!a||u.indexOf(i)>=0||i%2&&1===a&&!u[0]){var l=c.pattern;l.lastIndex=r;var f=l.exec(s);if(f&&f.index===r){var d=t.push({result:f,action:c.action,length:f[0].length});for(c.global&&(e=d);--d>e;){var p=d-1;if(t[d].length>t[p].length){var x=t[d];t[d]=t[p],t[p]=x}}}}}return t}this.state=0,this.index=0,this.input="",this.addRule=function(t,e,i){var r=t.global;if(!r){var s="g";t.multiline&&(s+="m"),t.ignoreCase&&(s+="i"),t=new RegExp(t.source,s)}return"[object Array]"!==Object.prototype.toString.call(i)&&(i=[0]),n.push({pattern:t,global:r,action:e,start:i}),this},this.setInput=function(t){return r=0,this.state=0,this.index=0,i.length=0,this.input=t,this},this.lex=function(){if(i.length)return i.shift();for(this.reject=!0;this.index<=this.input.length;){for(var e=s.call(this).splice(r),n=this.index;e.length&&this.reject;){var o=e.shift(),h=o.result,c=o.length;this.index+=c,this.reject=!1,r++;var u=o.action.apply(this,h);if(this.reject)this.index=h.index;else if(void 0!==u)switch(Object.prototype.toString.call(u)){case"[object Array]":i=u.slice(1),u=u[0];default:return c&&(r=0),u}}var a=this.input;if(n<a.length){if(this.reject){if(r=0,void 0!==(u=t.call(this,a.charAt(this.index++))))return"[object Array]"===Object.prototype.toString.call(u)?(i=u.slice(1),u[0]):u}else this.index!==n&&(r=0),this.reject=!0}else{if(!e.length)break;this.reject=!0}}}}t.exports=e,e.defunct=function(t){throw new Error("Unexpected character at index "+(this.index-1)+": "+t)}}));return function e(){if(!(this instanceof e))return new e;var i=new t((function(t){return t}));this.addRule=function(t,e){return i.addRule(t,e),this},this.preprocess=function(t){i.setInput(t);for(var e=[];i.index<t.length;){var n=i.lex();e.push(n)}return e.filter((function(t){return null!==t})).join("")},Object.defineProperty(this,"index",{get:function(){return i.index},enumerable:!0})}}));
